<!DOCTYPE html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Signable</title> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous"> 
    <link rel="stylesheet" href="{{ url_for('static', filename='sidebar/sidebar.css') }}"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" /> 

    <style>
        #notification {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #28a745;
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
            z-index: 9999;
        }
       
        .edited-cell {
            background-color: #fefeab !important;
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
            overflow-x: auto;
        }

        .hidden {
            display: none;
        }

        .btn {
            background-color: #ccf2f4;
            color: black;
            border-color: black;
        }

        .btn:hover {
            background-color: #e9e9e9; 
            border-color: black;
            color: black;
        }

      

      
        .table td {
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
            max-width: 150px !important;
            
        }

        .table td[contenteditable="true"] {
            white-space: nowrap;
            overflow-x: auto;
            word-break: break-all;
           
            
        }

        #loading-spinner {
            position: fixed;
            top: 10px;
            right: 80px;
        }

        #saving-text {
            position: fixed;
            top: 12px;
            right: 15px;
        }

        h3 {
            font-size: medium;
            text-align: center;
            margin-bottom: 5%;
        }

    </style>
 
</head> 
  
<body> 
    <div id="total" class="container-fluid p-0 d-flex h-100 "> 
        <div id="bdSidebar" class="d-flex flex-column flex-shrink-0 p-3 text-black offcanvas-md offcanvas-start width1" style="width: 70px">
            <ul class="mynav nav d-flex d-none d-md-block">   
                <li class="nav-item justify-content-right"> 
                    <a href="#"> 
                        <i id="hide" class="fa-solid fa-x text-black"></i>
                    </a> 
                </li>
            </ul> 
                
            <ul class="mynav nav d-flex ">
                <li>
                    <img class="logo" src="static/images/logo.png" alt="Logo">
                </li>
            </ul>
            
            <a href="#" class="navbar-brand"> 
            </a><hr> 
            <ul class="mynav nav nav-pills flex-column mb-auto "> 
                <li class="nav-item mb-1"> 
                    <a href="/home"> 
                        <i class="fa-solid fa-home text-black"></i> 
                        <span class="text text-black">  Home </span>
                    </a> 
                </li> 
                
  
                <li class="nav-item mb-1"> 
                    <a href="/courses">  
                        <i class="fas fa-regular fa-school text-black"></i> 
                        <span class="text text-black"> Learning Hub </span>
                    
                    </a> 
                </li> 

                <li class="nav-item mb-1"> 
                    <a href="/review"> 
                        <i class="fa-solid fa-layer-group text-black"></i> 
                        <span class="text text-black"> Review Stack </span>
                    </a> 
                </li> 

                <li class="nav-item mb-1"> 
                    <a href="/searchterm"> 
                        <i class="fa-solid fa-search text-black"></i> 
                        <span class="text text-black"> Search </span>
                    </a> 
                </li>

                <li class="nav-item mb-1"> 
                    <a href="/gloss"> 
                        <i class="fa-solid fa-file text-black"></i> 
                        <span class="text text-black"> Gloss </span>
                    </a> 
                </li> 
  
                <li class="sidebar-item nav-item mb-1"> 
                    <a href="#" class="sidebar-link collapsed" data-bs-toggle="collapse" data-bs-target="#settings" aria-expanded="false" aria-controls="settings"> 
                        <i class="fas fa-cog pe-2 text-black"></i> 
                        <span class="topic text text-black">Settings </span> 
                    </a> 
                    <ul id="settings" class="sidebar-dropdown list-unstyled collapse" data-bs-parent="#sidebar"> 
                        <li class="sidebar-item"> 
                            <a href="/logoutapp" class="sidebar-link"> 
                                <i class="fas fa-sign-out-alt pe-2" style="color: #6c757d;"></i>
                                <span class="topic" style="color: #6c757d;" >Log Out</span> 
                            </a> 
                        </li> 
                        <li class="sidebar-item"> 
                            <a class="sidebar-link" id="adminButton"> 
                                <i class="fas fa-user-cog" style="color: #6c757d;"></i>
                                <span class="topic" style="color: #6c757d;">Admin</span> 
                            </a>
                        </li>
                    </ul> 
                </li> 
            </ul> 
            <hr> 
            <div class="d-flex"> 
  
            </div> 
        </div> 
  
        <div class="bg-light flex-fill"> 
            <div class="p-2 d-md-none d-flex text-white color"> 
                <a id="mobileshow" href="#" class="text-white" data-bs-toggle="offcanvas" data-bs-target="#bdSidebar"> 
                    <i class="fa-solid fa-bars text-black"></i> 
                </a> 
                <span class="ms-3 text-black">Signable</span> 
            </div> 
            <div class="p-4"> 
                <nav style="--bs-breadcrumb-divider:'>';font-size:14px"> 
                    <ol class="breadcrumb m-0"> 
                        <li class="breadcrumb-item">Admin</li>  
                    </ol> 
                    <hr>
                </nav>

                <div class="row"> 
                    <div class="col"> 
                        <h1>Edit your courses here:</h1>
                        <ul class="nav nav-tabs">
                          <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#add">Add</a>
                          </li>
                          <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#remove">Edit/Delete</a>
                          </li>
                        </ul>

                        <div class="tab-content">
                          <div id="add" class="tab-pane fade show active">
                            <br>
                            <div class="row"> 
                                <div class="col"> 
                                    <form class="needs-validation"action="/add_card" method="POST" onsubmit="return checkInput()">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <div class="form-group">
                                            <div class="form-group">
                                                <label for="aslcourse">ASL Course</label>
                                                <small id="inputhelp" class="form-text text-muted"><span style="color: red;">*</span></small>
                                                <select id="courseinput"class="form-select" name="aslcourse" >
                                                    <option value="" disabled selected>Select Course</option>                                                    <option value="101">101</option>
                                                    <option value="102">102</option>
                                                    <option value="105">105</option>
                                                    <option value="107">107</option>
                                                </select>
                                                <div class="invalid-feedback">
                                                    Please select an ASL course
                                                </div>
                                             
                                            </div>
                                        </div>
                                        <br>
                                        <div class="form-group">
                                            <label for="asllesson">ASL Lesson</label>
                                            <small id="inputhelp" class="form-text text-muted">(for example: 3 or 12)<span style="color: red;">*</span></small>
                                            <input id="lessonnumberinput" type="number" class="form-control" name="asllesson" aria-describedby="emailHelp" placeholder="Enter Lesson"  min="0">
                                            <div class="invalid-feedback">
                                                 Please enter a lesson number
                                            </div>
                                        </div>
                                        <br>
                                        <div class="form-group">
                                            <label for="videolink">Video ID</label>
                                            <small id="inputhelp" class="form-text text-muted">(for example: enter NXRzRZFgSco from https://youtu.be/NXRzRZFgSco)<span style="color: red;">*</span></small>
                                            <input id="videolinkinput" class="form-control" name="videolink" aria-describedby="emailHelp" placeholder="Enter Video ID" >
                                            <div class="invalid-feedback">
                                                Please enter a video link
                                            </div>
                                        </div>
                                        <br>
                                        <div class="form-group">
                                            <label for="translation">English Translation</label>
                                            <small id="inputhelp" class="form-text text-muted">(for example: to-run or hello)<span style="color: red;">*</span></small>
                                            <input id="translationinput" class="form-control" name="translation" aria-describedby="emailHelp" placeholder="English Translation" >
                                            <div id="translationfeedback" class="invalid-feedback">
                                                Please limit the translation to less than 50 words
                                            </div>
                                        </div>
                                        <br>
                                        <div class="form-group">
                                            <label for="memory">Memory Tip</label>
                                            <small id="inputhelp" class="form-text text-muted">(for example: think of a salute)</small>
                                            <input id="memoryinput"class="form-control" name="memory" aria-describedby="emailHelp" placeholder="Enter Memory Tip">
                                            <div class="invalid-feedback">
                                                Please limit the memory tip to less than 300 characters
                                            </div>
                                        </div>
                                        <br>
                                        <div class="form-group">
                                            <label for="speech">Parts of Speech</label>
                                            <small id="inputhelp" class="form-text text-muted">(for example: verb or noun)</small>
                                            <input id="speechinput"class="form-control" name="speech" aria-describedby="emailHelp" placeholder="Enter Parts of Speech">
                                            <div class="invalid-feedback">
                                                Please limit the parts of speech to less than 200 characters
                                            </div>
                                        </div>
                                        <br>
                                        <div class="form-group">
                                            <label for="sentence">Example Sentence</label>
                                            <small id="inputhelp" class="form-text text-muted">(for example: DOG TO-RUN AROUND HOUSE)</small>
                                            <input id="sentenceinput" class="form-control" name="sentence" aria-describedby="emailHelp" placeholder="Enter Example Sentence">
                                            <div class="invalid-feedback">
                                                Please limit the example sentence to less than 300 characters
                                            </div>
                                        </div>
                                        <br>
                                        <div class="row justify-content-center">
                                            <div class="col-md-4 text-center">
                                                <button type="submit" class="btn btn-primary">Add</button>
                                            </div>
                                        </div>
                                    </form>
                                </div> 
                            </div> 
                          </div>
                          <div id="remove" class="tab-pane fade">
                            <br>
                            <div class="row"> 
                                <div class="col"> 
                                        <div class="form-group">
                                            <div class="text-center">
                                                <div class="btn-group">
                                                  <button type="button" class="btn btn-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">ASL 101</button>
                                                  <ul class="dropdown-menu">
                                                    
                                                    {% for lesson in asl101len %}
                                                        <li><a class="dropdown-item lesson-link" href="#" data-course="101" data-lesson="{{ lesson['lessonid'] }}">Lesson {{ lesson['lessonid'] }}</a></li>
                                                    {% endfor %}
                                                  </ul>
                                                </div>
                                                <div class="btn-group">
                                                    <button type="button" class="btn btn-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">ASL 102</button>
                                                    <ul class="dropdown-menu">
                                                        {% for lesson in asl102len %}
                                                        <li><a class="dropdown-item lesson-link" href="#" data-course="102" data-lesson="{{ lesson['lessonid'] }}">Lesson {{ lesson['lessonid'] }}</a></li>
                                                    {% endfor %}
                                                    </ul>
                                                  </div>
                                                  <div class="btn-group">
                                                    <button type="button" class="btn btn-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">ASL 105</button>
                                                    <ul class="dropdown-menu">
                                                        {% for lesson in asl105len %}
                                                        <li><a class="dropdown-item lesson-link" href="#" data-course="105" data-lesson="{{ lesson['lessonid'] }}">Lesson {{ lesson['lessonid'] }}</a></li>
                                                    {% endfor %}
                                                    </ul>
                                                  </div>
                                                  <div class="btn-group">
                                                    <button type="button" class="btn btn-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">ASL 107</button>
                                                    <ul class="dropdown-menu">
                                                        {% for lesson in asl107len %}
                                                        <li><a class="dropdown-item lesson-link" href="#" data-course="107" data-lesson="{{ lesson['lessonid'] }}">Lesson {{ lesson['lessonid'] }}</a></li>
                                                    {% endfor %}
                                                    </ul>
                                                  </div>

                                                  <div id="loading-spinner" class="spinner-border text-primary" role="status" style="display: none; margin-left: 100px;"> 
                                                  </div>
                                                  <span id="saving-text" style="display: none;">Saving...</span> 
                                              </div>
                                              <div class="container">
                                                <table class="table">
                                                    <h2 id="table-title" class="text-center pt-5 pb-3"></h2>
                                                    <div id="edit-message" style="display: none;">
                                                        <h3>Select cells to edit, changes are automatically saved</h3>
                                                    </div>
                                                    <thead class="hidden">
                                                        <tr>
                                                            <th>Term</th>
                                                            <th hidden>Card ID</th>
                                                            <th>Memory Tip</th>
                                                            <th>Part of Speech</th>
                                                            <th>Example Sentence</th>
                                                            <th>Remove</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="table-body">
                                                    </tbody>
                                                </table>
                                                <div class="text-center">
                                                    <button id="delete-lesson" class="btn btn-danger" style="display: none;">Delete Entire Lesson</button>
                                                </div>
                                            </div>
                                         
                                         
                                            <div id="notification">Changes saved successfully.</div>

                                </div> 
                            </div> 
                          </div>
                          </div>
                        </div>
                    </div> 
                </div> 
            </div> 
  
        </div> 
    </div> 
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>

        function checkInput(){
            translation_input = $("#translationinput").val()
            let isvalid = true

            if($("#courseinput").val() === null) {
                $("#courseinput").addClass("is-invalid")
                isvalid = false
            }
            else {
                $("#courseinput").removeClass("is-invalid")
            }

            if (translation_input.length > 50 || translation_input.length === 0 ) {
                if (translation_input.length === 0 ){
                    $("#translationfeedback").empty()
                    $("#translationfeedback").html("Please enter an ASL translation")
                } else {
                    $("#translationfeedback").empty()
                    $("#translationfeedback").html("Please limit the translation to less than 50 words")
                }
                $("#translationinput").addClass("is-invalid")
                isvalid = false
            } else {
                $("#translationinput").removeClass("is-invalid")
            }


            
            
            link_input = $("#videolinkinput").val()

            if (link_input.length === 0){
                $("#videolinkinput").addClass("is-invalid")
                isvalid = false
            } else {
                $("#videolinkinput").removeClass("is-invalid")
            }

            lesson_input = $("#lessonnumberinput").val()
          
            if (lesson_input.length === 0){
                $("#lessonnumberinput").addClass("is-invalid")
                isvalid = false
            } else {
                $("#lessonnumberinput").removeClass("is-invalid")
            }
          
            mem_tip = $("#memoryinput").val()
            if (mem_tip.length > 300){
                $("#memoryinput").addClass("is-invalid")
                isvalid = false
            } else {
                $("#memoryinput").removeClass("is-invalid")
            }
   
       
            
            sentence_input = $("#sentenceinput").val()
            if (sentence_input.length > 300){
                $("#sentenceinput").addClass("is-invalid")
                isvalid = false
            } else {
                $("#sentenceinput").removeClass("is-invalid")
            }
     

            speech_input = $("#speechinput").val()
            if (speech_input.length > 300){
                $("#speechinput").addClass("is-invalid")
                isvalid = false
            } else {
                $("#speechinput").removeClass("is-invalid")
            }


            return isvalid
        }

 

  // Fetch all the forms we want to apply custom Bootstrap validation styles to

       

        $(document).ready(function() {
            function fetchData(courseId, lessonNumber) {
                $.ajax({
                    url: `/fetch-lesson-terms/${courseId}/${lessonNumber}`,
                    method: 'GET',
                    success: function(terms) {
                        var courseName = $('#aslcourse option:selected').text(); 
                        $('#table-title').text(`ASL${courseId} Lesson ${lessonNumber}`); 
                        var tableBodyHTML = '';
                        terms.forEach(function(term) {
                            tableBodyHTML += `
                                <tr>
                                    <td contenteditable="false">${term.translation}</td>
                                    <td hidden>${term.cardid}</td>
                                    <td contenteditable="true">${term.memorytip}</td>
                                    <td contenteditable="true">${term.speech}</td>
                                    <td contenteditable="true">${term.sentence}</td>
                                    <td><button class="btn btn-danger remove-btn" data-cardid="${term.cardid}">Remove</button></td>
                                </tr>`;
                        });
                        $('#table-body').html(tableBodyHTML);
                        $('thead').removeClass('hidden');
                        $('#edit-message').show();
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching data: ' + error);
                    }
                });
            }
        
            $('.lesson-link').click(function(e) {
                e.preventDefault();
                var courseId = $(this).data('course');
                var lessonNumber = $(this).data('lesson');
                fetchData(courseId, lessonNumber);
                $('#delete-lesson').show();
            });
        });
        

    $(document).ready(function() {
        var typingTimer;
        var doneTypingInterval = 0;

        function showAutosaveNotification() {
            $('#notification').text('Autosaving changes...').fadeIn().delay(1000).fadeOut();
        }

        function showSpinner() {
            $('#loading-spinner').show();
        }

        function hideSpinner() {
            $('#loading-spinner').hide();
        }

        function showSavingText() {
            $('#saving-text').show();
        }
    
        function hideSavingText() {
            $('#saving-text').hide();
        }

        function saveChanges() {
            var data = [];
            $('#table-body tr').each(function() {
                var cardid = $(this).find('td:eq(1)').text(); 
                var translation = $(this).find('td:eq(0)').text(); 
                var memorytip = $(this).find('td:eq(2)').text(); 
                var speech = $(this).find('td:eq(3)').text(); 
                var sentence = $(this).find('td:eq(4)').text(); 
                data.push({ cardid: cardid, translation: translation, memorytip: memorytip, speech: speech, sentence: sentence });
            });

            var csrf_token = "{{ csrf_token() }}";

            $.ajaxSetup({
             beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrf_token);
                        }
             }})

            $.ajax({
                type: 'POST',
                url: '/savechanges',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    // Show autosave notification
                    // showAutosaveNotification();
                    showSpinner();
                    showSavingText();

                // Simulate saving data (replace with actual AJAX call)
                    setTimeout(function() {
                        // Hide spinner after data is saved
                        hideSavingText();
                        hideSpinner();
                        console.log('Data saved successfully.');
                    }, 2000);
                },
                error: function(xhr, status, error) {
                    console.error('Error saving changes: ' + error);
                }
            });
        }

        $('#table-body').on('input', 'td[contenteditable="true"]', function() {
            clearTimeout(typingTimer);
            typingTimer = setTimeout(saveChanges, doneTypingInterval);

            $(this).addClass('edited-cell');
        });


        $('#table-body').on('click', '.remove-btn', function() {
            var cardId = $(this).data('cardid');
    
            if (confirm('Are you sure you want to remove this card?')) {
                var row = $(this).closest('tr'); 
                var csrf_token = "{{ csrf_token() }}";

                $.ajaxSetup({
                 beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrf_token);
                        }
             }})


                $.ajax({
                    type: 'POST',
                    url: '/deleteflashcard',
                    data: JSON.stringify({ cardid: cardId }), 
                    contentType: 'application/json', 
                    success: function(response) {
                        row.remove();
                    },
                    error: function(xhr, status, error) {
                        console.error('Error deleting flashcard: ' + error);
                    }
                });
            } else {
                return;
            }
        });
    });

    $(document).ready(function() {
        function handleCellEditing() {
            $('#table-body td[contenteditable="true"]').on('input', function() {
                $(this).css('white-space', 'pre-wrap');
            });
        }
    
        handleCellEditing();

        $('#delete-lesson').click(function() {
            var titleText = $('#table-title').text();
            var match = titleText.match(/\d+/g); 
        
            if (match && match.length >= 2) {
                var courseId = match[0];
                var lessonNumber = match[1];
            

                
                if (confirm('Are you sure you want to delete the entire lesson?')) {
                    var csrf_token = "{{ csrf_token() }}";

                    $.ajaxSetup({
                 beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrf_token);
                        }
             }})
                    $.ajax({
                        type: 'POST',
                        url: '/delete-lesson',
                        data: JSON.stringify({lessonNumber: lessonNumber }),
                        contentType: 'application/json',
                        success: function(response) {
                            location.reload(); 
                        },
                        error: function(xhr, status, error) {
                            console.error('Error deleting lesson: ' + error);
                        }
                    });
                } else {
                    return;
                }
            } else {
                console.error('Error extracting courseId and lessonNumber from title.');
            }
        });
    });

    
</script>
    <script src="{{ url_for('static', filename='sidebar/sidebar.js') }}"></script>
</body> 
</html>
